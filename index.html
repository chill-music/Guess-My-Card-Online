<!DOCTYPE html>
<html lang="ar" dir="rtl" id="mainHtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تخمين الكارت - النسخة المصلحة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // إعدادات Firebase مباشرة لضمان العمل على أي استضافة (Netlify/GitHub)
        // ملاحظة: هذه القيم مأخوذة من صورك لضمان الربط الصحيح بسيرفرك
        const firebaseConfig = {
            apiKey: "AIzaSyCnmD9VzAwryverdyflav-PCPyNOT1yvqM",
            authDomain: "gueeswhat-552c5.firebaseapp.com",
            projectId: "gueeswhat-552c5",
            storageBucket: "gueeswhat-552c5.firebasestorage.app",
            messagingSenderId: "589839614487",
            appId: "1:589839614487:web:4852541c28a12b67e55252"
        };

        let db, auth, currentUser;
        const appId = "guess-my-card-v1";
        const roomId = "main_room";

        // وظيفة لإظهار رسائل الخطأ للمستخدم بدل الـ Alert
        const showError = (msg) => {
            const errBox = document.getElementById('error-display');
            errBox.innerText = msg;
            errBox.classList.remove('hidden');
            setTimeout(() => errBox.classList.add('hidden'), 5000);
        };

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // بدء تسجيل الدخول التلقائي
            signInAnonymously(auth).catch(e => {
                showError("فشل الاتصال بالسيرفر: تأكد من إعدادات Firebase");
                console.error(e);
            });

        } catch (e) {
            showError("حدث خطأ في تحميل التطبيق");
            console.error(e);
        }

        let playerRole = null;
        let maxPlayers = 2;

        const translations = {
            ar: {
                title: "تخمين الكارت - أونلاين",
                waiting: "في انتظار اللاعبين...",
                setup: "اختر مكانك لبدء اللعب",
                you: "أنت", player: "لاعب", capacity: "عدد اللاعبين:",
                reset: "إعادة ضبط الغرفة", spectator: "مشاهدة فقط"
            }
        };

        // مستمع لتغيرات الغرفة
        const initRoomListener = () => {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', roomId);
            onSnapshot(roomRef, (docSnap) => {
                if (!docSnap.exists()) {
                    setDoc(roomRef, { maxPlayers: 2, chat: [], open: false });
                    return;
                }
                const data = docSnap.data();
                updateUI(data);
            }, (err) => {
                showError("خطأ في المزامنة: ربما بسبب قواعد الحماية (Rules) في Firebase");
            });
        };

        function updateUI(data) {
            const grid = document.getElementById('playerGrid');
            grid.innerHTML = '';
            maxPlayers = data.maxPlayers || 2;

            for(let i=1; i<=maxPlayers; i++) {
                const pId = data[`p${i}Id`];
                const isOccupied = pId && pId !== auth.currentUser?.uid;
                const isMe = pId === auth.currentUser?.uid;
                
                const btn = document.createElement('button');
                btn.className = `p-6 rounded-2xl font-bold transition-all shadow-lg flex flex-col items-center justify-center ${isMe ? 'bg-green-600 ring-4 ring-green-400' : isOccupied ? 'bg-gray-800 opacity-50 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-500'}`;
                btn.innerHTML = `<span>${isMe ? 'أنت' : 'لاعب ' + i}</span>`;
                btn.onclick = () => { if(!isOccupied) joinGame(i); };
                grid.appendChild(btn);
            }
        }

        window.joinGame = async (role) => {
            if (!auth.currentUser) return showError("انتظر تحميل البيانات...");
            playerRole = role;
            try {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', roomId);
                await updateDoc(roomRef, { [`p${role}Id`]: auth.currentUser.uid });
                document.getElementById('setupZone').classList.add('hidden');
                document.getElementById('gameZone').classList.remove('hidden');
            } catch (e) {
                showError("عذراً، لم تنجح عملية الانضمام");
            }
        };

        window.changeCapacity = async (val) => {
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', roomId), { maxPlayers: val });
            } catch (e) { showError("لا يمكن تغيير العدد حالياً"); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) initRoomListener();
        });
    </script>
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="p-6 flex flex-col items-center min-h-screen">
    
    <div id="error-display" class="hidden fixed top-5 bg-red-600 text-white px-6 py-3 rounded-full shadow-2xl z-50 animate-bounce"></div>

    <div class="w-full max-w-2xl text-center mb-10">
        <h1 class="text-4xl font-black mb-2">GUESS MY CARD</h1>
        <p class="opacity-50 text-sm">تأكد من اتصالك بالإنترنت إذا لم تظهر الأزرار</p>
    </div>

    <div id="setupZone" class="w-full max-w-xl glass p-10 rounded-[2rem] text-center shadow-2xl">
        <p class="mb-8 opacity-70">اختر عدد اللاعبين أولاً ثم انضم لمكان فارغ:</p>
        
        <div class="flex justify-center gap-4 mb-10">
            <button onclick="changeCapacity(2)" class="w-12 h-12 rounded-xl bg-white/10 hover:bg-indigo-600 font-bold transition-all">2</button>
            <button onclick="changeCapacity(3)" class="w-12 h-12 rounded-xl bg-white/10 hover:bg-indigo-600 font-bold transition-all">3</button>
            <button onclick="changeCapacity(4)" class="w-12 h-12 rounded-xl bg-white/10 hover:bg-indigo-600 font-bold transition-all">4</button>
        </div>

        <div id="playerGrid" class="grid grid-cols-2 gap-4 mb-6">
            <!-- سيتم تحميل الأزرار هنا برمجياً -->
            <div class="col-span-2 py-10 opacity-30 animate-pulse">جاري الاتصال بالسيرفر...</div>
        </div>
    </div>

    <div id="gameZone" class="hidden w-full max-w-4xl text-center">
        <div class="glass p-20 rounded-[3rem]">
            <h2 class="text-2xl font-bold">تم الدخول بنجاح!</h2>
            <p class="mt-4 opacity-50">هذه النسخة للإصلاح، قم برفع كارتك الآن.</p>
            <button onclick="location.reload()" class="mt-10 px-8 py-3 bg-white text-black rounded-xl font-bold">إعادة تحميل</button>
        </div>
    </div>

</body>
</html>
